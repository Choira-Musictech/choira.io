var t,e=require("immer"),r=(t=e)&&"object"==typeof t&&"default"in t?t.default:t,n=require("react");function o(){return(o=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t}).apply(this,arguments)}function i(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}var c={Actions:{},AsyncState:{},Context:{__global:{}},Middlewares:{},Setter:{classSetter:void 0,functionSetter:{}},State:{},devTools:void 0,subscriptions:{},mutableState:{},gid:0,uid:0,storeId:0,currentStoreId:"0",withDevTools:!1},a={logger:{enable:!1},devtools:{enable:!1},tryCatch:{enable:!0}},s=function(t,e){try{var r=t.next;return Promise.resolve(a.tryCatch.enable?r(e).catch(function(t){return console.log(t)}):r(e))}catch(t){return Promise.reject(t)}},u=function(t,e){try{var r=function(){return Promise.resolve(s(e))},n=t.action,i=t.modelName,c=t.consumerActions,a=t.params,s=t.next,u=t.Global,l=t.type,f=function(){if("u"!==l)return Promise.resolve(n(a,o({actions:c(u.Actions[i],{modelName:i}),state:u.State[i]},u.Context.__global||{},u.Context[i]||{}))).then(function(e){t.newState=e||null});t.newState=n()}();return Promise.resolve(f&&f.then?f.then(r):r())}catch(t){return Promise.reject(t)}},l=function(t,e){try{var r=t.modelName,n=t.newState,o=t.next,i=t.Global,c=t.type;return i.Setter.functionSetter[r]&&!t.disableSelectorUpdate&&Object.keys(i.Setter.functionSetter[r]).map(function(t){var e=i.Setter.functionSetter[r][t];e&&e.selector&&!e.selectorRef&&(e.selectorRef=e.selector(i.State[r]))}),Promise.resolve(function(){if(n||"u"===c)return N(r,n||{}),Promise.resolve(o(e))}())}catch(t){return Promise.reject(t)}},f=function(t,e){try{var r=t.modelName,n=t.next,o=t.Global,i=t.__hash,c=o.Setter.functionSetter[r];return"f"===t.type&&i&&c&&c[i]&&c[i].setState&&c[i].setState(o.State[r]),Promise.resolve(n(e))}catch(t){return Promise.reject(t)}},m=function(t,e){try{var r=t.modelName,n=t.next,o=t.Global,i="u"===t.type?o.subscriptions[r]:o.subscriptions[r+"_"+t.actionName];return i&&i.forEach(function(e){e(t)}),Promise.resolve(n(e))}catch(t){return Promise.reject(t)}},S=function(t,e){try{var r=t.Global;return!0===a.logger.enable||"function"==typeof a.logger.enable&&a.logger.enable(t)?(console.group("%c "+t.modelName+" State Change %c "+(new Date).toLocaleTimeString(),"color: gray; font-weight: lighter;","color: black; font-weight: bold;"),console.log("%c Previous","color: #9E9E9E; font-weight: bold",r.State[t.modelName]),console.log("%c Action","color: #03A9F4; font-weight: bold",t.actionName,"payload: "+t.params),Promise.resolve(t.next(e)).then(function(e){return console.log("%c Next","color: #4CAF50; font-weight: bold",r.State[t.modelName]),console.groupEnd(),e})):Promise.resolve(t.next(e))}catch(t){return Promise.reject(t)}},d=function(t,e){try{var r=t.Global;return Promise.resolve(t.next(e)).then(function(e){return r.withDevTools&&a.devtools.enable&&r.devTools.send(t.modelName+"_"+t.actionName,r.State),e})}catch(t){return Promise.reject(t)}},p=function(t,e){try{var r=t.modelName,n=t.next,o=t.Global,i=t.disableSelectorUpdate;return o.Setter.classSetter&&o.Setter.classSetter(o.State),o.Setter.functionSetter[r]&&Object.keys(o.Setter.functionSetter[r]).map(function(t){var e=o.Setter.functionSetter[r][t];if(e)if(!e.selector||i)e.setState(o.State[r]);else{var n=e.selector(o.State[r]);x(n,e.selectorRef)||(e.selectorRef=n,e.setState(o.State[r]))}}),Promise.resolve(n(e))}catch(t){return Promise.reject(t)}},b=[s,S,d,u,l,f,p,m],v={communicator:p,consoleDebugger:S,devToolsListener:d,getNewState:u,getNewStateWithCache:function(t){return void 0===t&&(t=5e3),function(e,r){try{var n=e.Global,o=e.modelName,i=e.next,c=e.actionName;return Promise.resolve(Promise.race([(0,e.action)(e.params,{actions:(0,e.consumerActions)(n.Actions[o],{modelName:o}),state:n.State[o]}),E(t,j(o,c))])).then(function(t){return e.newState=t||null,Promise.resolve(i(r))})}catch(t){return Promise.reject(t)}}},setNewState:l,stateUpdater:f,subscription:m,tryCatch:s,config:a},_=function(t,e){try{return e.next=function(t){return t.length>0?t[0](e,t.slice(1)):e.newState},Promise.resolve(t[0](e,t.slice(1)))}catch(t){return Promise.reject(t)}},h=n.createContext({}),y=h.Consumer;if(!console.group){var g=[],P="-".repeat(80);console.group=function(t){g.push(t),console.log("%c \nBEGIN GROUP: %c",P,t),console.groupEnd=function(){console.log("END GROUP: %c\n%c",g.pop(),P)}}}var w=function(t,e){var r={};return Object.keys(t).forEach(function(n){r[n]=function(t,e){return function(r,n){try{return Promise.resolve(_(b,{Global:c,action:t,actionName:t.name,consumerActions:w,middlewareConfig:n,modelName:e.modelName,newState:null,params:r,type:"o"}))}catch(t){return Promise.reject(t)}}}(t[n],e)}),r},N=function(t,e){if("function"==typeof e){var n=c.State[t];n=r(n,e),c.State=r(c.State,function(e){e[t]=n})}else c.State=r(c.State,function(r){r[t]=o({},r[t],e)});return c.State},E=function(t,e){return new Promise(function(r){return setTimeout(function(){console.log(t),r(e)},t)})},O=function(t,e){try{var n={__FROM_SERVER__:!0};return Promise.resolve(Promise.all(Object.keys(c.State).map(function(i){try{var a=e&&e.prefix||"",s=function(){if(!t||!t.modelName||i===a+t.modelName||-1!==t.modelName.indexOf(a+i)){var s=function(t){e&&e.isServer?n[i]=t:c.State=r(c.State,function(e){e[i]=o({},e[i],t)})},u=c.AsyncState[i];return u?Promise.resolve(u(t)).then(s):s({})}}();return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(t){return Promise.reject(t)}}))).then(function(){return e&&e.isServer?n:c.State})}catch(t){return Promise.reject(t)}},j=function(t,e){var r=localStorage.getItem("__REACT_MODELX__"+t+"_"+e);return r?JSON.parse(r):null},x=function(t,e){if(t===e)return!0;if("object"!=typeof t||null===t||"object"!=typeof e||null===e)return!1;var r=Object.keys(t),n=Object.keys(e);if(r.length!==n.length)return!1;for(var o=0;o<r.length;o++)if(!Object.prototype.hasOwnProperty.call(e,r[o])||t[r[o]]!==e[r[o]])return!1;return!0};e.enableES5();var A="undefined"==typeof window?n.useEffect:n.useLayoutEffect,R=function(t,e){C(t,e,void 0)},C=function(t,e,r){Array.isArray(e)?e.forEach(function(e){c.subscriptions[t+"_"+e]||(c.subscriptions[t+"_"+e]=[]),r?c.subscriptions[t+"_"+e].push(r):c.subscriptions[t+"_"+e]=[]}):(c.subscriptions[t+"_"+e]||(c.subscriptions[t+"_"+e]=[]),r?c.subscriptions[t+"_"+e].push(r):c.subscriptions[t+"_"+e]=[])},T=function(t){return c.State[t]},I=function(t,e){void 0===e&&(e={type:"o"});var r={};return Object.keys(c.Actions[t]).forEach(function(n){return r[n]=function(r,i){try{var a=o({action:c.Actions[t][n],actionName:n,consumerActions:w,middlewareConfig:i,modelName:t,newState:null,params:r},e,{Global:c});return Promise.resolve(_(c.Middlewares[t]?c.Middlewares[t]:b,a))}catch(t){return Promise.reject(t)}}}),r},M=function(t,e){var r,o=n.useState({})[1],i=n.useRef(""),a=(r=[t],function(t){return r.reduce(function(t,e){return t&&t[e]?t[e]:null},t)})(c.mutableState),s=!!a,u=s?a.selector:e,l=s?a:T(t);if(A(function(){c.uid+=1;var e=""+c.uid;return i.current=e,c.Setter.functionSetter[t]||(c.Setter.functionSetter[t]={}),c.Setter.functionSetter[t][e]={setState:o,selector:u},function(){delete c.Setter.functionSetter[t][e]}},[]),s)return u(l);var f=I(t,{__hash:i.current,type:"f"});return[u?u(l):l,f]},G=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).state=c.State,e}return i(e,t),e.prototype.render=function(){var t=this.props.children;return c.Setter.classSetter=this.setState.bind(this),n.createElement(h.Provider,{value:o({},this.state)},t)},e}(n.PureComponent);exports.Consumer=y,exports.Model=function(t,e,n){if(void 0!==t.state){c.storeId+=1;var i="__"+c.storeId;c.State=r(c.State,function(e){e[i]=t.state}),t.middlewares&&(c.Middlewares[i]=t.middlewares),c.Actions[i]=t.actions,c.AsyncState[i]=t.asyncState,e&&(c.Context[i]=e);var a=I(i);return{__id:i,actions:a,getState:function(){return T(i)},subscribe:function(t,e){return C(i,t,e)},unsubscribe:function(t){return R(i,t)},useStore:function(t){return M(i,t)}}}e?c.gid=1:c.gid+=1;var s="";if(c.gid>1&&(s=c.gid+"_"),t.actions){console.error("invalid model(s) schema: ",t);var u=function(t){return function(){return t}};return{__ERROR__:!0,actions:u({}),getActions:u({}),getInitialState:u({}),getState:u({}),subscribe:u(),unsubscribe:u(),useStore:u([{},{}])}}e&&!e.__FROM_SERVER__&&(c.State=r(c.State,function(t){Object.assign(t,e||{})})),n&&(c.Context.__global=n);var l={};return Object.keys(t).forEach(function(n){var i=s+n,a=t[n];if(a.__ERROR__)return console.error(i+" model's schema is invalid"),c.State=r(c.State,function(t){t[i]={}}),void(c.Actions[i]={});void 0===a.useStore?(e&&e.__FROM_SERVER__?c.State=r(c.State,function(t){t[i]=o({},a.state,e[i])}):c.State[i]||(c.State=r(c.State,function(t){t[i]=a.state})),a.middlewares&&(c.Middlewares[i]=a.middlewares),c.Actions[i]=a.actions,c.AsyncState[i]=a.asyncState):(c.State[i]&&e||(c.State=r(c.State,function(t){t[i]=t[a.__id]})),e&&e.__FROM_SERVER__&&(c.State=r(c.State,function(t){t[i]=o({},t[a.__id],e[i])})),c.Actions[i]=c.Actions[a.__id],c.AsyncState[i]=c.AsyncState[a.__id],c.Middlewares[i]=c.Middlewares[a.__id],c.Context[i]=c.Context[a.__id]),l[n]=I(i)}),c.withDevTools="undefined"!=typeof window&&window.__REDUX_DEVTOOLS_EXTENSION__,c.withDevTools&&v.config.devtools.enable&&(c.devTools=window.__REDUX_DEVTOOLS_EXTENSION__,c.devTools.connect()),{actions:l,getActions:function(t){return I(s+t)},getInitialState:function(t,e){try{return Promise.resolve(O(t,o({},e,{prefix:s})))}catch(t){return Promise.reject(t)}},getState:function(t){return T(s+t)},subscribe:function(t,e,r){return C(s+t,e,r)},unsubscribe:function(t,e){return R(s+t,e)},useStore:function(t,e){return M(s+t,e)}}},exports.Provider=G,exports.actionMiddlewares=b,exports.connect=function(t,e,r){return function(a){return function(s){function u(){return s.apply(this,arguments)||this}return i(u,s),u.prototype.render=function(){var i=this,s=this.props,u=s.state,l=void 0===u?{}:u,f=s.actions,m=void 0===f?{}:f;return n.createElement(y,null,function(s){var u=s[""+t],f=c.Actions[t];return n.createElement(a,Object.assign({},i.props,{state:o({},l,e?e(u):u),actions:o({},m,r?r(w(f,{modelName:t})):w(f,{modelName:t}))}))})},u}(n.PureComponent)}},exports.createStore=function(t,e){var r="string"==typeof t;c.storeId+=r?0:1;var n=r?t:c.storeId.toString();c.Actions[n]||(c.Actions[n]={}),c.mutableState[n]||(c.mutableState[n]={count:0});var o=function(){return c.mutableState[n].count=0,c.currentStoreId=n,e?e():t()};return c.mutableState[n].selector=o,{useStore:function(){return M(n,o)},getState:function(){return o()},subscribe:function(t){c.subscriptions[n]||(c.subscriptions[n]=[]),c.subscriptions[n].push(t)},unsubscribe:function(t){if(c.subscriptions[n]&&t){var e=c.subscriptions[n].indexOf(t);e>=0&&c.subscriptions[n].splice(e,1)}}}},exports.getInitialState=O,exports.getState=T,exports.middlewares=v,exports.useModel=function(t){var e=c.currentStoreId,n=c.mutableState[e].count;return c.mutableState[e].count+=1,c.mutableState[e].hasOwnProperty(n)||(c.mutableState[e][n]="function"==typeof t?t():t),[c.mutableState[e][n],function(t){try{return c.mutableState[e][n]="function"==typeof t?r(c.mutableState[e][n],t):c.mutableState[e][n]&&t&&"Object"===c.mutableState[e][n].constructor.name&&"Object"===t.constructor.name?o({},c.mutableState[e][n],t):t,Promise.resolve(_(b,{Global:c,action:function(){return"function"==typeof t?c.mutableState[e][n]:t},actionName:"setter",consumerActions:w,disableSelectorUpdate:!0,middlewareConfig:{},modelName:e,newState:{},params:void 0,type:"u"}))}catch(t){return Promise.reject(t)}}]};
